{% extends "layouts/app_layout.html" %}
{% load humanize %}

{% block title %}{{ company.name }} - CRM{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-start">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">{{ company.name }}</h1>
            <div class="flex items-center space-x-3 mt-1">
                <span class="px-2 py-1 text-xs font-medium rounded-full
                    {% if company.category == 'CLIENT' %}bg-green-100 text-green-800
                    {% elif company.category == 'PROSPECT' %}bg-blue-100 text-blue-800
                    {% elif company.category == 'PARTNER' %}bg-purple-100 text-purple-800
                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                    {{ company.get_category_display }}
                </span>
                {% if company.industry %}
                <span class="text-gray-500">{{ company.industry }}</span>
                {% endif %}
            </div>
        </div>
        <div class="flex space-x-3">
            <a href="{% url 'crm:contact_create' %}?company={{ company.pk }}" class="btn-secondary">+ Contact</a>
            <a href="{% url 'crm:opportunity_create' %}?company={{ company.pk }}" class="btn-secondary">+ Opportunité</a>
            <a href="{% url 'crm:company_update' company.pk %}" class="btn-primary">Modifier</a>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Content -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Info -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-lg font-medium text-gray-900 mb-4">Informations</h2>
                <dl class="grid grid-cols-2 gap-4">
                    {% if company.siret %}
                    <div><dt class="text-sm text-gray-500">SIRET</dt><dd class="font-medium">{{ company.siret }}</dd></div>
                    {% endif %}
                    {% if company.email %}
                    <div><dt class="text-sm text-gray-500">Email</dt><dd><a href="mailto:{{ company.email }}" class="text-primary-600">{{ company.email }}</a></dd></div>
                    {% endif %}
                    {% if company.phone %}
                    <div><dt class="text-sm text-gray-500">Téléphone</dt><dd><a href="tel:{{ company.phone }}" class="text-primary-600">{{ company.phone }}</a></dd></div>
                    {% endif %}
                    {% if company.website %}
                    <div><dt class="text-sm text-gray-500">Site web</dt><dd><a href="{{ company.website }}" target="_blank" class="text-primary-600">{{ company.website }}</a></dd></div>
                    {% endif %}
                </dl>
                {% if company.address %}
                <div class="mt-4 pt-4 border-t">
                    <dt class="text-sm text-gray-500">Adresse</dt>
                    <dd>{{ company.address }}<br>{{ company.postal_code }} {{ company.city }}{% if company.country %}, {{ company.country }}{% endif %}</dd>
                </div>
                {% endif %}
            </div>

            <!-- Contacts -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-medium text-gray-900">Contacts ({{ contacts|length }})</h2>
                    <a href="{% url 'crm:contact_create' %}?company={{ company.pk }}" class="text-sm text-primary-600">+ Ajouter</a>
                </div>
                {% if contacts %}
                <ul class="divide-y">
                    {% for contact in contacts %}
                    <li class="py-3 flex items-center justify-between">
                        <div>
                            <a href="{{ contact.get_absolute_url }}" class="font-medium text-gray-900 hover:text-primary-600">{{ contact.display_name }}</a>
                            <p class="text-sm text-gray-500">{{ contact.job_title|default:"-" }}</p>
                        </div>
                        <div class="text-sm text-gray-500">{{ contact.email }}</div>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-sm text-gray-500 text-center py-4">Aucun contact</p>
                {% endif %}
            </div>

            <!-- Opportunities -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-medium text-gray-900">Opportunités ({{ opportunities|length }})</h2>
                    <a href="{% url 'crm:opportunity_create' %}?company={{ company.pk }}" class="text-sm text-primary-600">+ Ajouter</a>
                </div>
                {% if opportunities %}
                <ul class="divide-y">
                    {% for opp in opportunities %}
                    <li class="py-3 flex items-center justify-between">
                        <div>
                            <a href="{{ opp.get_absolute_url }}" class="font-medium text-gray-900 hover:text-primary-600">{{ opp.name }}</a>
                            <span class="ml-2 px-2 py-0.5 text-xs rounded-full" style="background-color: {{ opp.stage.color }}20; color: {{ opp.stage.color }}">{{ opp.stage.name }}</span>
                        </div>
                        <div class="text-sm font-medium">{{ opp.amount|floatformat:0|intcomma }} €</div>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-sm text-gray-500 text-center py-4">Aucune opportunité</p>
                {% endif %}
            </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
            <!-- Stats -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-sm font-medium text-gray-500 mb-4">Statistiques</h3>
                <dl class="space-y-3">
                    <div class="flex justify-between"><dt class="text-gray-600">Contacts</dt><dd class="font-medium">{{ company.contacts_count }}</dd></div>
                    <div class="flex justify-between"><dt class="text-gray-600">Opportunités</dt><dd class="font-medium">{{ company.opportunities_count }}</dd></div>
                    <div class="flex justify-between"><dt class="text-gray-600">Pipeline total</dt><dd class="font-medium">{{ company.total_opportunities_value|floatformat:0|intcomma }} €</dd></div>
                </dl>
            </div>

            {% if company.notes %}
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-sm font-medium text-gray-500 mb-2">Notes</h3>
                <p class="text-sm text-gray-700 whitespace-pre-wrap">{{ company.notes }}</p>
            </div>
            {% endif %}

            <div class="bg-white rounded-lg shadow p-6">
                <a href="{% url 'crm:company_delete' company.pk %}" class="btn-danger w-full justify-center" onclick="return confirm('Supprimer cette entreprise ?')">Supprimer</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}
