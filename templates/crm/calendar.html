{% extends "layouts/app_layout.html" %}

{% block title %}Calendrier - CRM - PME-SI{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">
<style>
    .fc {
        font-family: inherit;
    }
    .fc-toolbar-title {
        font-size: 1.25rem !important;
        font-weight: 600;
    }
    .fc-button {
        background-color: #f3f4f6 !important;
        border-color: #e5e7eb !important;
        color: #374151 !important;
        font-weight: 500 !important;
    }
    .fc-button:hover {
        background-color: #e5e7eb !important;
    }
    .fc-button-active {
        background-color: #6366f1 !important;
        border-color: #6366f1 !important;
        color: white !important;
    }
    .fc-event {
        cursor: pointer;
        border-radius: 4px;
        font-size: 0.75rem;
        padding: 2px 4px;
    }
    .fc-event-completed {
        opacity: 0.6;
        text-decoration: line-through;
    }
    .fc-event-cancelled {
        opacity: 0.4;
        text-decoration: line-through;
    }
    .fc-daygrid-day-number {
        font-size: 0.875rem;
        color: #374151;
    }
    .fc-daygrid-day.fc-day-today {
        background-color: #EEF2FF !important;
    }
    .fc-col-header-cell-cushion {
        color: #6B7280;
        font-weight: 500;
        font-size: 0.75rem;
        text-transform: uppercase;
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Calendrier</h1>
            <p class="text-gray-600">Vue calendrier des activités CRM</p>
        </div>
        <div class="flex flex-wrap gap-2">
            <a href="{% url 'crm:activity_list' %}" class="btn-secondary btn-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
                </svg>
                Liste
            </a>
            <a href="{% url 'crm:activity_create' %}" class="btn-primary btn-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                Nouvelle activité
            </a>
        </div>
    </div>

    <!-- Legend -->
    <div class="card">
        <div class="card-body">
            <div class="flex flex-wrap gap-4 text-sm">
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded" style="background-color: #3B82F6;"></span>
                    <span>Appel</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded" style="background-color: #10B981;"></span>
                    <span>Email</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded" style="background-color: #8B5CF6;"></span>
                    <span>Réunion</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded" style="background-color: #F59E0B;"></span>
                    <span>Tâche</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded" style="background-color: #EC4899;"></span>
                    <span>Démonstration</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded" style="background-color: #14B8A6;"></span>
                    <span>Proposition</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar -->
    <div class="card">
        <div class="card-body">
            <div id="calendar"></div>
        </div>
    </div>
</div>

<!-- Event Detail Modal -->
<div id="eventModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeModal()"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="flex items-start">
                    <div id="eventIcon" class="flex-shrink-0 flex items-center justify-center h-10 w-10 rounded-full"></div>
                    <div class="ml-4 flex-1">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="eventTitle"></h3>
                        <div class="mt-2 space-y-2">
                            <p class="text-sm text-gray-500" id="eventType"></p>
                            <p class="text-sm text-gray-500" id="eventDate"></p>
                            <p class="text-sm text-gray-600" id="eventDescription"></p>
                            <p class="text-sm text-gray-500" id="eventContact"></p>
                            <p class="text-sm text-gray-500" id="eventCompany"></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" onclick="closeModal()" class="btn-secondary w-full sm:w-auto">
                    Fermer
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');

    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'fr',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
        },
        buttonText: {
            today: "Aujourd'hui",
            month: 'Mois',
            week: 'Semaine',
            day: 'Jour',
            list: 'Liste'
        },
        firstDay: 1, // Monday
        events: function(info, successCallback, failureCallback) {
            fetch(`{% url 'crm:calendar_events_api' %}?start=${info.startStr}&end=${info.endStr}`)
                .then(response => response.json())
                .then(data => successCallback(data))
                .catch(error => {
                    console.error('Error loading events:', error);
                    failureCallback(error);
                });
        },
        eventClick: function(info) {
            showEventModal(info.event);
        },
        eventDidMount: function(info) {
            // Add tooltip
            info.el.title = info.event.title;
        },
        height: 'auto',
        navLinks: true,
        nowIndicator: true
    });

    calendar.render();
});

function showEventModal(event) {
    const modal = document.getElementById('eventModal');
    const props = event.extendedProps;

    document.getElementById('eventTitle').textContent = event.title;
    document.getElementById('eventType').innerHTML = `<span class="badge" style="background-color: ${event.backgroundColor}20; color: ${event.backgroundColor}">${props.type}</span> <span class="badge badge-secondary">${props.status}</span>`;
    document.getElementById('eventDate').textContent = new Date(event.start).toLocaleString('fr-FR', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
    document.getElementById('eventDescription').textContent = props.description || '';
    document.getElementById('eventContact').textContent = props.contact ? `Contact: ${props.contact}` : '';
    document.getElementById('eventCompany').textContent = props.company ? `Entreprise: ${props.company}` : '';
    document.getElementById('eventIcon').style.backgroundColor = event.backgroundColor + '20';
    document.getElementById('eventIcon').innerHTML = `<svg class="w-5 h-5" style="color: ${event.backgroundColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>`;

    modal.classList.remove('hidden');
}

function closeModal() {
    document.getElementById('eventModal').classList.add('hidden');
}

// Close modal on escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeModal();
});
</script>
{% endblock %}
